<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party Playlister</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .album-art-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
            gap: 17px;
            z-index: -10;
        }
        .album-art-item {
            aspect-ratio: 1 / 1;
            background-size: cover;
            background-position: center;
            border-radius: 0.5rem;
            opacity: 0.2;
            animation: float 20s ease-in-out infinite;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .album-art-item:hover {
            opacity: 0.4;
            transform: scale(1.05);
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }
            25% {
                transform: translateY(-15px) rotate(1deg);
            }
            50% {
                transform: translateY(0px) rotate(-1deg);
            }
            75% {
                transform: translateY(15px) rotate(0.5deg);
            }
        }
        
        .slider-thumb {
            appearance: none;
            width: 100%;
            height: 8px;
            background: #374151;
            border-radius: 5px;
            outline: none;
        }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4ade80;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Album Art Background Grid -->
    <div id="album-art-grid" class="album-art-grid"></div>

    <div class="relative w-full max-w-lg bg-gray-900 bg-opacity-80 rounded-3xl p-8 shadow-2xl border border-gray-800 space-y-8 backdrop-blur-md">
        <div class="text-center">
            <h1 class="text-4xl font-black tracking-tight text-white mb-2">Party Playlister</h1>
            <p class="text-gray-400">Select artists and a year range for the perfect vibe.</p>
        </div>

        <!-- Mode Indicator & Login Section -->
        <div id="mode-section">
            <!-- Demo Mode Banner -->
            <div id="demo-mode-banner" class="hidden bg-yellow-500/20 border border-yellow-500/30 rounded-2xl p-4 mb-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">ðŸŽµ</span>
                    <div class="flex-1">
                        <p class="text-yellow-300 font-bold text-sm mb-1">Demo Mode</p>
                        <p class="text-yellow-200/80 text-xs mb-3">You're trying it out! Playlists will be created in the demo account.</p>
                        <button id="login-from-demo" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold px-4 py-2 rounded-lg transition-all">
                            Login to Save to Your Spotify
                        </button>
                    </div>
                </div>
            </div>

            <!-- User Mode Indicator -->
            <div id="user-mode-banner" class="hidden bg-green-500/20 border border-green-500/30 rounded-2xl p-3 mb-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-green-400 text-xl">âœ“</span>
                        <span class="text-green-300 text-sm font-bold">Connected to Your Spotify</span>
                    </div>
                    <button id="logout-button" class="text-red-400 hover:text-red-300 text-xs font-medium">Logout</button>
                </div>
            </div>

            <!-- No Auth Available -->
            <div id="no-auth-banner" class="hidden bg-gray-800 border border-gray-700 rounded-2xl p-6 text-center space-y-4">
                <p class="text-gray-300">Connect your Spotify account to create playlists</p>
                <button id="login-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl transition-all">
                    ðŸŽµ Login with Spotify
                </button>
            </div>
        </div>

        <!-- Main App -->
        <div id="app-section" class="space-y-6">
            <!-- Playlist Name Input -->
            <div>
                <label for="playlist-name" class="block text-xs font-bold uppercase tracking-widest text-gray-500 mb-2">Playlist Name</label>
                <input type="text" id="playlist-name" placeholder="e.g., Summer Night Drive" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:ring-2 focus:ring-green-400 focus:border-transparent outline-none transition-all">
            </div>

            <!-- Artist Input -->
            <div>
                <label for="artist-search" class="block text-xs font-bold uppercase tracking-widest text-gray-500 mb-2">Favorite Artists (Max 6)</label>
                <div id="artist-tokens-container" class="flex flex-wrap gap-2 mb-3"></div>
                <div class="relative">
                    <input type="text" id="artist-search" placeholder="Search for artists..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:ring-2 focus:ring-green-400 focus:border-transparent outline-none transition-all">
                    <div id="artist-suggestions" class="absolute z-10 w-full mt-2 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl max-h-48 overflow-y-auto hidden"></div>
                </div>
            </div>

            <!-- Release Year Range -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold uppercase tracking-widest text-gray-500 mb-2">From Year</label>
                    <input type="number" id="start-year" placeholder="2010" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white outline-none focus:ring-2 focus:ring-green-400">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase tracking-widest text-gray-500 mb-2">To Year</label>
                    <input type="number" id="end-year" placeholder="2024" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white outline-none focus:ring-2 focus:ring-green-400">
                </div>
            </div>

            <!-- Number of Songs Slider -->
            <div class="space-y-3">
                <label for="song-count" class="flex justify-between text-xs font-bold uppercase tracking-widest text-gray-500">
                    Number of Songs <span id="song-count-value" class="text-green-400 font-bold">20</span>
                </label>
                <input type="range" id="song-count" min="5" max="50" value="20" class="slider-thumb">
            </div>

            <!-- Message Box -->
            <div id="message-box" class="hidden text-center py-3 px-4 rounded-xl text-sm font-medium transition-all duration-300"></div>

            <!-- Generate Button -->
            <button id="generate-button" class="w-full bg-white text-black font-bold py-4 rounded-2xl shadow-lg transform transition-all active:scale-95 hover:bg-green-500 hover:text-white disabled:opacity-50">
                Generate Playlist
            </button>
            
            <!-- Result Area -->
            <div id="result-link-container" class="mt-4 p-6 bg-gray-800 rounded-2xl border border-green-500/30 text-center hidden">
                <p id="result-mode-text" class="text-gray-400 text-xs mb-2"></p>
                <a id="result-link" href="#" target="_blank" class="text-green-400 hover:text-green-300 text-lg font-bold underline decoration-2 underline-offset-4">Open on Spotify</a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const BACKEND_URL = 'http://localhost:5500';

            const demoModeBanner = document.getElementById('demo-mode-banner');
            const userModeBanner = document.getElementById('user-mode-banner');
            const noAuthBanner = document.getElementById('no-auth-banner');
            const loginButton = document.getElementById('login-button');
            const loginFromDemo = document.getElementById('login-from-demo');
            const logoutButton = document.getElementById('logout-button');
            const appSection = document.getElementById('app-section');
            const playlistNameInput = document.getElementById('playlist-name');
            const artistSearchInput = document.getElementById('artist-search');
            const artistSuggestions = document.getElementById('artist-suggestions');
            const artistTokensContainer = document.getElementById('artist-tokens-container');
            const startYearInput = document.getElementById('start-year');
            const endYearInput = document.getElementById('end-year');
            const songCountSlider = document.getElementById('song-count');
            const songCountValue = document.getElementById('song-count-value');
            const generateButton = document.getElementById('generate-button');
            const resultLinkContainer = document.getElementById('result-link-container');
            const resultLink = document.getElementById('result-link');
            const resultModeText = document.getElementById('result-mode-text');
            const messageBox = document.getElementById('message-box');
            const albumArtGrid = document.getElementById('album-art-grid');

            const selectedArtists = new Set();
            const MAX_ARTISTS = 6;
            let currentMode = 'none';
            
            // Fetch and populate real album art from popular artists
            async function populateAlbumArt() {
                const CACHE_KEY = 'spotify_album_art_cache';
                const CACHE_DURATION = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds
                
                // Try to load from cache first
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    try {
                        const { timestamp, images } = JSON.parse(cached);
                        const now = Date.now();
                        
                        // Check if cache is still valid
                        if (now - timestamp < CACHE_DURATION) {
                            console.log('Loading album art from cache');
                            images.forEach(imageUrl => {
                                const item = document.createElement('div');
                                item.className = 'album-art-item';
                                item.style.backgroundImage = `url('${imageUrl}')`;
                                item.style.animationDelay = `${Math.random() * 5}s`;
                                item.style.animationDuration = `${15 + Math.random() * 10}s`;
                                albumArtGrid.appendChild(item);
                            });
                            return; // Exit early, we used cached data
                        }
                    } catch (e) {
                        console.log('Cache invalid, fetching fresh data');
                    }
                }

                // If no valid cache, fetch fresh data
                console.log('Fetching fresh album art from Spotify');
                const popularArtists = [
                    'Tyla', 'Drake', 'The Weeknd', 'Ariana Grande', 'Ed Sheeran',
                    'Billie Eilish', 'Post Malone', 'Dua Lipa', 'Travis Scott', 'SZA',
                    'Bad Bunny', 'Harry Styles', 'Olivia Rodrigo', 'Doja Cat', 'Kendrick Lamar',
                    'Bruno Mars', 'Rihanna', 'BeyoncÃ©', 'Justin Bieber', 'Adele',
                    'Coldplay', 'Imagine Dragons', 'The Chainsmokers', 'Twenty One Pilots', 'Maroon 5',
                    'Shawn Mendes', 'Kanye West', 'J. Cole', 'Future', 'Metro Boomin',
                    'Sabrina Carpenter', 'Charli XCX', 'Tyler, The Creator', 'Frank Ocean', 'Lana Del Rey',
                    'Arctic Monkeys', 'Tame Impala', 'Mac Miller', 'Khalid', 'J Cole',
                    'Megan Thee Stallion', 'Lil Nas X', 'Camila Cabelllo'
                ];

                const fetchedImages = [];

                try {
                    // Fetch album art for multiple artists
                    for (let i = 0; i < popularArtists.length; i++) {
                        const artist = popularArtists[i];
                        
                        try {
                            const response = await fetch(
                                `${BACKEND_URL}/api/search-artists?q=${encodeURIComponent(artist)}`,
                                { credentials: 'include' }
                            );
                            
                            const data = await response.json();
                            const artists = data.artists || data;
                            
                            if (artists && artists.length > 0 && artists[0].images && artists[0].images.length > 0) {
                                const imageUrl = artists[0].images[0].url;
                                fetchedImages.push(imageUrl);
                                
                                const item = document.createElement('div');
                                item.className = 'album-art-item';
                                item.style.backgroundImage = `url('${imageUrl}')`;
                                item.style.animationDelay = `${Math.random() * 5}s`;
                                item.style.animationDuration = `${15 + Math.random() * 10}s`;
                                albumArtGrid.appendChild(item);
                            }
                        } catch (err) {
                            console.log(`Failed to fetch art for ${artist}`);
                        }
                        
                        // Small delay to avoid rate limiting
                        if (i % 5 === 0) await new Promise(r => setTimeout(r, 200));
                    }
                    
                    // Save to cache
                    if (fetchedImages.length > 0) {
                        localStorage.setItem(CACHE_KEY, JSON.stringify({
                            timestamp: Date.now(),
                            images: fetchedImages
                        }));
                        console.log(`Cached ${fetchedImages.length} album covers`);
                    }
                } catch (error) {
                    console.error('Error populating album art:', error);
                    // Fallback to placeholder images
                    for(let i=0; i<40; i++) {
                        const item = document.createElement('div');
                        item.className = 'album-art-item';
                        item.style.backgroundImage = `url('https://picsum.photos/seed/${i+10}/200')`;
                        item.style.animationDelay = `${Math.random() * 5}s`;
                        item.style.animationDuration = `${15 + Math.random() * 10}s`;
                        albumArtGrid.appendChild(item);
                    }
                }
            }

            // Update UI based on auth mode
            function updateModeUI(mode) {
                currentMode = mode;
                
                // Hide all banners first
                demoModeBanner.classList.add('hidden');
                userModeBanner.classList.add('hidden');
                noAuthBanner.classList.add('hidden');
                
                // Show appropriate banner
                if (mode === 'user') {
                    userModeBanner.classList.remove('hidden');
                    appSection.classList.remove('hidden');
                } else if (mode === 'demo') {
                    demoModeBanner.classList.remove('hidden');
                    appSection.classList.remove('hidden');
                } else {
                    noAuthBanner.classList.remove('hidden');
                    appSection.classList.add('hidden');
                }
            }

            // Check authentication status on load
            async function checkAuthStatus() {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/auth-status`, {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    updateModeUI(data.mode);
                } catch (error) {
                    console.error('Auth check error:', error);
                    updateModeUI('none');
                }
            }

            // Open Spotify login
            function openLogin() {
                const authWindow = window.open(
                    `${BACKEND_URL}/login`,
                    'Spotify Login',
                    'width=600,height=700'
                );

                // Listen for auth success message
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'spotify-auth-success') {
                        checkAuthStatus();
                        showMessage('Successfully logged in!', 'bg-green-500/20', 'text-green-400');
                    }
                });
            }

            // Login button handlers
            loginButton.addEventListener('click', openLogin);
            loginFromDemo.addEventListener('click', openLogin);

            // Logout button handler
            logoutButton.addEventListener('click', async () => {
                try {
                    await fetch(`${BACKEND_URL}/logout`, { credentials: 'include' });
                    checkAuthStatus();
                    selectedArtists.clear();
                    renderArtistTokens();
                    showMessage('Logged out. Switched to demo mode.', 'bg-blue-500/20', 'text-blue-400');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            });

            songCountSlider.addEventListener('input', () => {
                songCountValue.textContent = songCountSlider.value;
            });

            // Artist Search
            artistSearchInput.addEventListener('input', async (e) => {
                const query = e.target.value.trim();
                artistSuggestions.innerHTML = '';
                
                if (query.length > 1) {
                    try {
                        const response = await fetch(
                            `${BACKEND_URL}/api/search-artists?q=${encodeURIComponent(query)}`,
                            { credentials: 'include' }
                        );

                        const data = await response.json();
                        const artists = data.artists || data;

                        if (artists && artists.length > 0) {
                            artists.forEach(artist => {
                                if (!selectedArtists.has(artist.name)) {
                                    const div = document.createElement('div');
                                    div.textContent = artist.name;
                                    div.className = 'p-3 cursor-pointer hover:bg-gray-700 border-b border-gray-700 last:border-0 text-sm';
                                    div.addEventListener('click', () => {
                                        if (selectedArtists.size < MAX_ARTISTS) {
                                            selectedArtists.add(artist.name);
                                            renderArtistTokens();
                                            artistSearchInput.value = '';
                                            artistSuggestions.classList.add('hidden');
                                        } else {
                                            showMessage(`Limit reached: ${MAX_ARTISTS} artists max.`, "bg-red-500/20", "text-red-400");
                                        }
                                    });
                                    artistSuggestions.appendChild(div);
                                }
                            });
                            artistSuggestions.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error('Search error:', error);
                    }
                } else {
                    artistSuggestions.classList.add('hidden');
                }
            });

            function renderArtistTokens() {
                artistTokensContainer.innerHTML = '';
                selectedArtists.forEach(artist => {
                    const token = document.createElement('div');
                    token.className = 'flex items-center bg-gray-800 text-green-400 border border-green-500/30 text-xs font-bold px-3 py-1.5 rounded-full';
                    token.innerHTML = `<span>${artist}</span><button data-artist="${artist}" class="ml-2 hover:text-white">âœ•</button>`;
                    artistTokensContainer.appendChild(token);
                });
            }

            artistTokensContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    selectedArtists.delete(e.target.getAttribute('data-artist'));
                    renderArtistTokens();
                }
            });

            // Generate Playlist
            generateButton.addEventListener('click', async () => {
                const playlistName = playlistNameInput.value.trim();
                const artists = Array.from(selectedArtists);
                const startYear = startYearInput.value;
                const endYear = endYearInput.value;
                const songCount = songCountSlider.value;

                if (!playlistName) return showMessage("Please name your playlist.", "bg-red-500/20", "text-red-400");
                if (artists.length === 0) return showMessage("Select at least one artist.", "bg-red-500/20", "text-red-400");

                showMessage("Generating your vibe...", "bg-blue-500/20", "text-blue-400");
                generateButton.disabled = true;
                resultLinkContainer.classList.add('hidden');
                
                try {
                    const response = await fetch(`${BACKEND_URL}/api/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            name: playlistName,
                            artists,
                            startYear,
                            endYear,
                            songCount: parseInt(songCount)
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        resultLink.href = data.url;
                        resultLink.textContent = `Open "${data.name}" on Spotify`;
                        
                        // Show different message based on mode
                        if (data.mode === 'demo') {
                            resultModeText.textContent = 'âœ¨ Demo playlist created! Login to save to your own Spotify account.';
                        } else {
                            resultModeText.textContent = 'âœ“ Your playlist is ready!';
                        }
                        
                        resultLinkContainer.classList.remove('hidden');
                        showMessage("Playlist Ready!", "bg-green-500/20", "text-green-400");
                    } else {
                        throw new Error(data.error || 'Failed to generate playlist.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showMessage(`Error: ${error.message}`, "bg-red-500/20", "text-red-400");
                } finally {
                    generateButton.disabled = false;
                }
            });

            function showMessage(text, bgColor, textColor) {
                messageBox.textContent = text;
                messageBox.className = `block text-center py-3 px-4 rounded-xl text-sm font-bold ${bgColor} ${textColor}`;
                messageBox.classList.remove('hidden');
                if (bgColor.includes('green') || bgColor.includes('red')) {
                    setTimeout(() => messageBox.classList.add('hidden'), 5000);
                }
            }

            // Check auth on page load
            checkAuthStatus();
            
            // Populate album art after checking auth
            populateAlbumArt();
        });
    </script>
</body>
</html>